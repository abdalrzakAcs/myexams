<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ø§Ù… My Exams</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --primary:#0069d9;--primary-hover:#0053b3;--light-bg:#f5f7fa;
      --card-bg:#ffffff;--border:#dfe3e8;--text-dark:#212529;
      --shadow:0 6px 24px rgba(0,0,0,.08);--danger:#dc3545;
    }
    *{box-sizing:border-box;font-family:"Cairo",sans-serif;transition:.3s}
    body{margin:0;padding:32px 16px;background:var(--light-bg);color:var(--text-dark)}
    h2{text-align:center;margin-bottom:32px;font:700 2.2rem/1 "Cairo";
        color:var(--primary);text-shadow:0 2px 4px rgba(0,0,0,.1)}
    .login-box{max-width:420px;margin:0 auto 40px;background:#fff;padding:28px;
               border-radius:20px;box-shadow:var(--shadow);text-align:center}
    .login-box input,.login-box button{width:100%;padding:14px;margin:12px 0;
               border:1px solid var(--border);border-radius:10px;font-size:1rem}
    .login-box button{background:var(--primary);color:#fff;font-weight:700;
               cursor:pointer;box-shadow:0 3px 12px rgba(0,105,217,.3)}
    .login-box button:hover{background:var(--primary-hover);transform:scale(1.05)}
    #taskForm{display:none;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
              gap:20px;max-width:1150px;margin:0 auto;background:var(--card-bg);
              padding:36px;border-radius:20px;box-shadow:var(--shadow);align-items:end}
    #taskForm label{display:flex;flex-direction:column;font-weight:600;gap:8px}
    #taskForm input,#taskForm button{padding:14px 16px;border:1px solid var(--border);
              border-radius:12px;font-size:1rem}
    #taskForm button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    #taskForm button:hover{background:var(--primary-hover);transform:scale(1.04)}
    .table-wrapper{max-width:100%;overflow-x:auto;margin-top:48px}
    table{width:100%;min-width:1250px;border-collapse:collapse;background:var(--card-bg);
          border-radius:20px;overflow:hidden;box-shadow:var(--shadow)}
    thead th{position:sticky;top:0;background:#e9ecef;font-weight:bold;
             font-size:1rem;padding:16px 0}
    th,td{padding:14px 12px;border:1px solid var(--border);text-align:center;font-size:.9rem}
    tr:nth-child(even){background:#fdfdfd}tr:hover{background:#f1f5f8}
    .accounting-row td{background:#fef9e7;font-weight:bold}
    .total-summary{margin-top:20px;max-width:1150px;background:#fff;padding:20px;
                   border-radius:16px;box-shadow:var(--shadow);font-size:1.1rem}
  </style>
</head>
<body>
  <div style="text-align:center;margin-bottom:20px">
    <p style="font-size:1.8rem;font-weight:bold;color:#0069d9;margin:0;
              text-shadow:0 2px 4px rgba(0,0,0,.1)">
      Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
    </p>
  </div>

  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù…Ø´Ø±ÙˆØ¹ My Exams</h2>

  <div class="login-box" id="loginBox">
    <input type="password" id="adminPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />

<button type="button" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>

  </div>

  <form id="taskForm">
    <label><input type="checkbox" id="priorityFlag" /> Ø£ÙˆÙ„ÙˆÙŠØ©</label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©<input type="text" id="sessionNumber" required/></label>
    <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°<input type="text" id="teacherName" required/></label>
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµÙˆÙŠØ±<input type="date" id="recordDate" required/></label>
    <button type="button" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
  </form>

  <div class="table-wrapper">
    <table id="taskTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
          <th>ØªÙ†Ø³ÙŠÙ‚</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø³Ù‚</th><th>Ø±ÙØ¹</th><th>Ø§Ø³Ù… Ø§Ù„Ø±Ø§ÙØ¹</th>
          <th>Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ù</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„</th><th>Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ø±Ø§ÙØ¹</th>
          <th>Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¦Ù„Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµÙˆÙŠØ±</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ØµÙˆØ±</th>
          <th>Ù…ÙˆÙ†ØªØ§Ø¬</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ù†ØªØ¬</th><th>Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„</th>
          <th>Ø§Ù„Ù†Ø´Ø± ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨ÙˆØ³Øª Ù…Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©</th><th>Ø§Ø³Ù… Ø§Ù„ÙƒØ§ØªØ¨</th>
          <th>ØªØ³ÙˆÙŠÙ‚ ÙˆØ­Ù…Ù„Ø§Øª Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ù…Ø¹ÙŠÙ†Ø©</th><th>Ø§Ù„ÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="total-summary" id="summaryBox" style="display:none">
    ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙØ©:</strong> <span id="totalCost">0</span> Ù„.Ø³
  </div>

  <!-- Appwrite CDN -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>

  <script>
    /**********  Ø¥Ø¹Ø¯Ø§Ø¯ Appwrite + Ø¬Ù„Ø³Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø©  **********/
    const { Client, Databases, Account, ID } = Appwrite;
    const client = new Client()
      .setEndpoint('https://fra.cloud.appwrite.io/v1')
      .setProject('66cf3db2002471686c6f');

    const account   = new Account(client);
    const databases = new Databases(client);

    const databaseId   = '68136c4cee33221deb0f';
    const collectionId = 'tasks';

account.createAnonymousSession()
   .then(() => {
    console.log('âœ… Anonymous session ready');
    window.sessionReady = true;          // â­ï¸ Ø¶Ø±ÙˆØ±ÙŠ
 })
   .catch(console.error);

    /**********  Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„  **********/
    const PASSWORDS = { admin: 'admin123', accountant: 'account123' };
    let currentRole = 'guest';

    /**********  Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„  **********/
function checkLogin () {
  const pass = document.getElementById('adminPass').value.trim();
  if      (pass === PASSWORDS.admin)      currentRole = 'admin';
  else if (pass === PASSWORDS.accountant) currentRole = 'accountant';
  else { alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }

  loginBox.style.display     = 'none';
  taskForm.style.display     = currentRole === 'admin' ? 'grid' : 'none';
  summaryBox.style.display   = 'block';

  calculateSummary();

  // âœ… ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¬Ø§Ù‡Ø²Ø©
  if (window.sessionReady) {
    loadFromAppwrite();
  } else {
    const interval = setInterval(() => {
      if (window.sessionReady) {
        loadFromAppwrite();
        clearInterval(interval);
      }
    }, 200);
  }
}



    /**********  Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯  **********/
  document.getElementById('addBtn').addEventListener('click', () => {
  const priority = priorityFlag.checked ? 'âœ…' : 'âŒ';
  addLectureRow(priority,
                sessionNumber.value.trim(),
                teacherName.value.trim(),
                recordDate.value);

  taskForm.reset();
  sortTable();
});


    function addLectureRow(priority, num, teacher, date, skipSave = false) {
      const body = tableBodyEl;
      const mainRow = document.createElement('tr');
      const costRow = document.createElement('tr');
      costRow.classList.add('accounting-row');

      // Ø£ÙˆÙ„ÙˆÙŠØ© + Ø±Ù‚Ù… + Ø£Ø³ØªØ§Ø°
      [priority, num, teacher].forEach(v => {
        const td = document.createElement('td'); td.textContent = v; mainRow.appendChild(td);
      });

      // 19 Ø®Ø§Ù†Ø© Ù…Ù‡Ø§Ù…
      for (let i = 0; i < 19; i++) {
        const td = document.createElement('td');
        td.contentEditable = true; td.style.direction = 'rtl';
        mainRow.appendChild(td);
      }

      // Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµÙˆÙŠØ± (Ø§Ù„Ø¹Ù…ÙˆØ¯ 13)
      mainRow.children[13].textContent = date;

      // Ø®Ø§Ù†Ø© Ø§Ù„ÙƒÙ„ÙØ© Ø¨Ø§Ù„ØµÙ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠÙ‹Ø§)
      mainRow.appendChild(document.createElement('td'));

      // Ø²Ø± Ø§Ù„Ø­Ø°Ù
      const del = document.createElement('td');
      del.innerHTML = "<span style='cursor:pointer;color:var(--danger);font-weight:bold;font-size:1.2rem'>âœ–</span>";
      del.onclick = () => { mainRow.remove(); costRow.remove(); calculateSummary(); };
      mainRow.appendChild(del);

      /* ----- ØµÙ Ø§Ù„ÙƒÙ„Ù ----- */
      for (let i = 0; i < 3; i++) costRow.appendChild(document.createElement('td')); // Ø£ÙˆÙ„ÙˆÙŠØ©+Ø±Ù‚Ù…+Ø£Ø³ØªØ§Ø°
      for (let i = 0; i < 19; i++) {
        const td = document.createElement('td');
        td.contentEditable = true; td.style.direction = 'rtl'; td.classList.add('cost-input');
        td.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); updateRowTotal(costRow); } });
        costRow.appendChild(td);
      }
      const totalCell = document.createElement('td'); totalCell.classList.add('total-cell'); costRow.appendChild(totalCell);
      costRow.appendChild(document.createElement('td')); // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ§Ø±Øº

body.appendChild(mainRow); body.appendChild(costRow);
      // Ø­ÙØ¸ Ø¨Ø§Ù„Ù…Ø®Ø¯Ù‘Ù…
      if (!skipSave) saveRowToAppwrite(mainRow, costRow);

      // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª (blur)
      [...mainRow.querySelectorAll('td[contenteditable]'),
       ...costRow.querySelectorAll('td[contenteditable]')]
        .forEach(td => td.addEventListener('blur', () => syncRowUpdate(mainRow, costRow)));
    }

    /**********  Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ ÙƒÙ„ÙØ© ØµÙ ÙˆØ§Ø­Ø¯  **********/
    function updateRowTotal(costRow) {
      let sum = 0;
      costRow.querySelectorAll('td.cost-input').forEach(c => {
        const v = parseFloat(c.textContent.replace(/,/g, '').trim());
        if (!isNaN(v)) sum += v;
      });
      const totalCell = costRow.querySelector('.total-cell');
      totalCell.textContent = sum ? sum.toLocaleString() : '';
      calculateSummary();
    }

    /**********  Ø­ÙØ¸ ØµÙ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Appwrite  **********/
    function saveRowToAppwrite(mainRow, costRow) {
      const mainTds = mainRow.querySelectorAll('td');
      const costTds = costRow.querySelectorAll('td.cost-input');
      const payload = {
        priority      : mainTds[0].textContent,
        lectureNumber : mainTds[1].textContent,
        teacherName   : mainTds[2].textContent,
        recordDate    : mainTds[13].textContent,
        mainCells     : [...mainTds].slice(3, mainTds.length - 2).map(td => td.textContent),
        costs         : [...costTds].map(td => td.textContent),
        totalCost     : costRow.querySelector('.total-cell').textContent
      };
      databases.createDocument(databaseId, collectionId, ID.unique(), payload)
        .then(doc => { mainRow.dataset.docId = costRow.dataset.docId = doc.$id; })
        .catch(console.error);
    }

    /**********  Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ  **********/
    function syncRowUpdate(mainRow, costRow) {
      const id = mainRow.dataset.docId;
      if (!id) return;                      // Ù„Ø³Ø© Ù…Ø§ Ø§Ù†Ø­ÙØ¸
      updateRowTotal(costRow);              // Ø£Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹

      const mainTds = mainRow.querySelectorAll('td');
      const costTds = costRow.querySelectorAll('td.cost-input');
      const newData = {
        priority      : mainTds[0].textContent,
        lectureNumber : mainTds[1].textContent,
        teacherName   : mainTds[2].textContent,
        recordDate    : mainTds[13].textContent,
        mainCells     : [...mainTds].slice(3, mainTds.length - 2).map(td => td.textContent),
        costs         : [...costTds].map(td => td.textContent),
        totalCost     : costRow.querySelector('.total-cell').textContent
      };
      databases.updateDocument(databaseId, collectionId, id, newData).catch(console.error);
    }

    /**********  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Appwrite  **********/
    function loadFromAppwrite() {
      databases.listDocuments(databaseId, collectionId).then(({ documents }) => {
        documents.forEach(doc => {
          addLectureRow(doc.priority, doc.lectureNumber, doc.teacherName, doc.recordDate, true);
          const rows = document.querySelectorAll('#tableBody tr');
          const costRow = rows[rows.length - 1];
          const mainRow = rows[rows.length - 2];
          mainRow.dataset.docId = costRow.dataset.docId = doc.$id;

          mainRow.querySelectorAll('td').forEach((td, i) => {
            if (i >= 3 && i < mainRow.children.length - 2)
              td.textContent = doc.mainCells[i - 3] || '';
          });
          costRow.querySelectorAll('td.cost-input').forEach((td, i) => {
            td.textContent = doc.costs[i] || '';
          });
          costRow.querySelector('.total-cell').textContent = doc.totalCost || '';
        });
        calculateSummary();
      }).catch(console.error);
    }

    /**********  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„Ù‘ÙŠ  **********/
    function calculateSummary() {
      let total = 0;
      document.querySelectorAll('.total-cell').forEach(c => {
        const v = parseFloat(c.textContent.replace(/,/g, ''));
        if (!isNaN(v)) total += v;
      });
      totalCost.textContent = total.toLocaleString();
    }

    /**********  ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ  **********/
    function sortTable() {
      const body = tableBodyEl;
      const pairs = [];
      for (let i = 0; i < body.children.length; i += 2) {
        const main = body.children[i], cost = body.children[i + 1];
        const priority = main.children[0].textContent === 'âœ…' ? 0 : 1;
        const date = new Date(main.children[13].textContent || '2100-01-01').getTime();
        pairs.push({ main, cost, priority, date });
      }
      pairs.sort((a, b) => a.priority - b.priority || a.date - b.date);
      pairs.forEach(p => { body.appendChild(p.main); body.appendChild(p.cost); });
    }

    /**********  Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ù€ Right-Click  **********/
    document.addEventListener('contextmenu', e => {
      if (!e.target.isContentEditable) return;

      const nameCols = [4,6,8,10,12,14,16,18,20];
      const cell = e.target;
      const col  = [...cell.parentNode.children].indexOf(cell);

      const menu = document.createElement('div');
      menu.style = `position:fixed;top:${e.clientY}px;left:${e.clientX}px;background:#fff;
        border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);
        z-index:1000;padding:6px 0;min-width:160px`;
      document.querySelectorAll('body > .context-menu-color').forEach(m => m.remove());
      menu.classList.add('context-menu-color');

      if (nameCols.includes(col)) {
        ["ÙƒÙ†Ø§Ù† Ø§Ù„ÙØ±Ø§Ù†","Ø£Ø­Ù…Ø¯ Ø²Ø±Ù†ÙŠØ®","Ù…Ø§ÙŠØ§ ×•Ù‡Ø§Ø¨ÙŠØ©","Ø³Ù†Ø§ Ø²ÙŠØ§Ø¯Ø©","Ù…ØµØ·ÙÙ‰ Ø­Ù…Ø²Ø©","Ù…Ø­Ù…Ø¯ ÙØ§Ø±Ø³"]
          .forEach(name=>{
            const o=document.createElement('div');
            o.textContent=name;o.style.padding='10px 16px';o.style.cursor='pointer';
            o.onclick=()=>{cell.textContent=name;menu.remove();};
            menu.appendChild(o);
          });
      } else {
        const colors=["transparent","#fff9c4","#ffe082","#c8e6c9","#212121"];
        const names =["Ø´ÙØ§Ù","Ø£ØµÙØ± ÙØ§ØªØ­","Ø£ØµÙØ± ØºØ§Ù…Ù‚","Ø£Ø®Ø¶Ø±","Ø£Ø³ÙˆØ¯"];
        colors.forEach((color,i)=>{
          const o=document.createElement('div');
          o.textContent=names[i];o.style.padding='10px 16px';o.style.cursor='pointer';
          o.style.background=color==='transparent'?'#fff':color;
          o.style.color=color==="#212121"?"#fff":"#000";
          o.onclick=()=>{cell.style.background=color;menu.remove();};
          menu.appendChild(o);
        });
      }

      document.body.appendChild(menu);
      document.addEventListener('click',()=>{if(menu.parentNode)menu.remove()},{once:true});
      e.preventDefault();
    });

    /**********  Ø¹Ù†Ø§ØµØ± Ù…Ø®ØªØµØ±Ø© Ù„Ù„ÙˆØµÙˆÙ„  **********/
    const adminPass   = document.getElementById('adminPass');
    const loginBox    = document.getElementById('loginBox');
    const taskForm    = document.getElementById('taskForm');
    const summaryBox  = document.getElementById('summaryBox');
    const tableBodyEl = document.getElementById('tableBody');
    const totalCost   = document.getElementById('totalCost');
    const priorityFlag= document.getElementById('priorityFlag');
    const sessionNumber=document.getElementById('sessionNumber');
    const teacherName = document.getElementById('teacherName');
    const recordDate  = document.getElementById('recordDate');
  </script>
</body>
</html>

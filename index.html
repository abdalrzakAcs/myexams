<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ø§Ù… My Exams</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
<style>
  :root{
    --primary:#0069d9;--primary-hover:#0053b3;--light-bg:#f5f7fa;
    --card-bg:#ffffff;--border:#dfe3e8;--text-dark:#212529;
    --shadow:0 6px 24px rgba(0,0,0,.08);--danger:#dc3545;
  }
  *{box-sizing:border-box;font-family:"Cairo",sans-serif;transition:.3s}
  body{margin:0;padding:32px 16px;background:var(--light-bg);color:var(--text-dark)}
  h2{text-align:center;margin-bottom:32px;font:700 2.2rem/1 "Cairo";
      color:var(--primary);text-shadow:0 2px 4px rgba(0,0,0,.1)}

  .login-box{max-width:420px;margin:0 auto 40px;background:#fff;padding:28px;
             border-radius:20px;box-shadow:var(--shadow);text-align:center}
  .login-box input,.login-box button{width:100%;padding:14px;margin:12px 0;
             border:1px solid var(--border);border-radius:10px;font-size:1rem}
  .login-box button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer;
             box-shadow:0 3px 12px rgba(0,105,217,.3)}
  .login-box button:hover{background:var(--primary-hover);transform:scale(1.05)}

  #taskForm{display:none;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:20px;max-width:1150px;margin:0 auto;background:var(--card-bg);
            padding:36px;border-radius:20px;box-shadow:var(--shadow);align-items:end}
  #taskForm label{display:flex;flex-direction:column;font-weight:600;gap:8px}
  #taskForm input,#taskForm select,#taskForm button{
            padding:14px 16px;border:1px solid var(--border);
            border-radius:12px;font-size:1rem}
  #taskForm button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
  #taskForm button:hover{background:var(--primary-hover);transform:scale(1.04)}

  .table-wrapper{max-width:100%;max-height:70vh;overflow:auto;margin-top:48px;
                 border-radius:20px;box-shadow:var(--shadow);background:var(--card-bg)}
  table{width:100%;min-width:1350px;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#e9ecef;font-weight:bold;padding:16px 0}
  th,td{padding:12px 10px;border:1px solid var(--border);text-align:center;font-size:.9rem;white-space:nowrap}
  tr:nth-child(even){background:#fdfdfd}
  tr:hover:not(.accounting-row){background:#f1f5f8}
  .accounting-row td{background:#fffde7;font-weight:bold}

  .total-summary{margin-top:20px;max-width:1150px;background:#fff;padding:20px;
                 border-radius:16px;box-shadow:var(--shadow);font-size:1.1rem}

  .context-menu-color{animation:fadeIn .12s ease-out;border-radius:8px}
  @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
</style>
</head>
<body>
<div style="text-align:center;margin-bottom:20px">
  <p style="font-size:1.8rem;font-weight:bold;color:#0069d9;margin:0;
            text-shadow:0 2px 4px rgba(0,0,0,.1)">
    Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
  </p>
</div>

<h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù…Ø´Ø±ÙˆØ¹ My Exams</h2>

<!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="login-box" id="loginBox">
  <input type="password" id="adminPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <button type="button" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ -->
<form id="taskForm">
  <label><input type="checkbox" id="priorityFlag" /> Ø£ÙˆÙ„ÙˆÙŠØ©</label>
  <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©<input type="text" id="sessionNumber" required/></label>
  <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°<input type="text" id="teacherName" required/></label>
  <label>ØªØ§Ø±ÙŠØ®/Ø³Ø§Ø¹Ø© Ø§Ù„ØªØµÙˆÙŠØ±
    <input type="datetime-local" id="recordDateTime" required/>
  </label>
  <label>Ø§Ù„Ù‚Ø§Ø¹Ø©
    <select id="recordRoom" required>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <button type="button" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
</form>

<!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
<div class="table-wrapper">
  <table id="taskTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>ØªÙ†Ø³ÙŠÙ‚</th><th>Ù…Ù†Ø³Ù‚</th><th>Ø±ÙØ¹</th><th>Ø±Ø§ÙØ¹</th>
        <th>Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ù</th><th>Ù…Ø¯Ø®Ù„</th><th>Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø©</th><th>Ø±Ø§ÙØ¹</th>
        <th>Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¦Ù„Ø©</th><th>Ù…Ø¯Ø®Ù„</th><th>Ø§Ù„ØªØµÙˆÙŠØ±</th><th>Ø§Ù„Ù‚Ø§Ø¹Ø©</th><th>Ø§Ù„Ù…ØµÙˆØ±</th>
        <th>Ù…ÙˆÙ†ØªØ§Ø¬</th><th>Ù…Ù…Ù†ØªØ¬</th><th>Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ</th><th>Ù…Ø¯Ø®Ù„</th>
        <th>ØªØµÙ…ÙŠÙ…/ÙƒØªØ§Ø¨Ø©</th><th>Ø§Ù„ÙƒØ§ØªØ¨</th><th>ØªØ³ÙˆÙŠÙ‚</th>
        <th>Ø§Ù„ÙƒÙ„ÙØ©</th><th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
<div class="total-summary" id="summaryBox" style="display:none">
  ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙØ©:</strong> <span id="totalCost">0</span> Ù„.Ø³
</div>

<!-- Appwrite CDN -->
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Appwrite ========== */
const { Client, Databases, Account, ID } = Appwrite;
const client = new Client()
  .setEndpoint('https://fra.cloud.appwrite.io/v1')
  .setProject('66cf3db2002471686c6f');

const account   = new Account(client);
const databases = new Databases(client);

const databaseId   = '68136c4cee33221deb0f';
const collectionId = 'tasks';

account.get()
  .then(()=>{window.sessionReady=true;})
  .catch(()=>{
    account.createAnonymousSession()
      .then(()=>{window.sessionReady=true;})
      .catch(console.error);
  });

/* ---------- Ø¹Ù†Ø§ØµØ± DOM ---------- */
const adminPass   = document.getElementById('adminPass');
const addBtn      = document.getElementById('addBtn');

const loginBox    = document.getElementById('loginBox');
const taskForm    = document.getElementById('taskForm');
const summaryBox  = document.getElementById('summaryBox');
const tableBodyEl = document.getElementById('tableBody');
const totalCost   = document.getElementById('totalCost');

const priorityFlag  = document.getElementById('priorityFlag');
const sessionNumber = document.getElementById('sessionNumber');
const teacherName   = document.getElementById('teacherName');
const recordDateTime= document.getElementById('recordDateTime');
const recordRoom    = document.getElementById('recordRoom');

/* ---------- ØµÙ„Ø§Ø­ÙŠØ§Øª ---------- */
const PASSWORDS  = { admin:'Admin12', accountant:'account123' };
let   currentRole= 'guest';

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
function checkLogin(){
  const pass = adminPass.value.trim();
  if(pass===PASSWORDS.admin)      currentRole='admin';
  else if(pass===PASSWORDS.accountant) currentRole='accountant';
  else return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

  loginBox.style.display='none';
  taskForm.style.display  = currentRole==='admin' ? 'grid' : 'none';
  summaryBox.style.display= 'block';

  if(window.sessionReady) loadFromAppwrite(); else {
    const int=setInterval(()=>{if(window.sessionReady){loadFromAppwrite();clearInterval(int);}},200);
  }
}

/* ========== Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ========== */
addBtn.addEventListener('click',()=>{
  const p = priorityFlag.checked ? 'âœ…' : 'âŒ';
  addLectureRow(p,
    sessionNumber.value.trim(),
    teacherName.value.trim(),
    recordDateTime.value,
    recordRoom.value
  );
  taskForm.reset(); sortTable();
});
function deleteRow(main, cost){
  const id = main.dataset.docId;
  if (id){
    databases.deleteDocument(databaseId, collectionId, id)
      .then(() => {
        main.remove();
        cost.remove();
        calculateSummary();
      })
      .catch(console.error);
  } else {
    main.remove();
    cost.remove();
    calculateSummary();
  }
}
function addLectureRow(priority,num,teacher,dateTime,room,skipSave=false){
  const body = tableBodyEl;
  const main = document.createElement('tr');
  const cost = document.createElement('tr'); cost.classList.add('accounting-row');

  /* Ø«Ø§Ø¨ØªØ© */
  [priority,num,teacher].forEach(v=>{
    const td=document.createElement('td');td.textContent=v;main.appendChild(td);
  });

  /* 19 Ø®Ø§Ù†Ø© Ù…Ù‡Ø§Ù… */
  for(let i=0;i<19;i++){
    const td=document.createElement('td');
    td.contentEditable=true;td.style.direction='rtl';
    main.appendChild(td);
  }

  /* Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø§Ù„Ù‚Ø§Ø¹Ø© */
  const dateTd=document.createElement('td'); dateTd.textContent=dateTime; main.appendChild(dateTd);
  const roomTd=document.createElement('td'); roomTd.textContent=room;     main.appendChild(roomTd);

  /* Ø§Ù„Ù…ØµÙˆØ± + Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
  main.appendChild(document.createElement('td')); // Ø§Ù„Ù…ØµÙˆØ±
  for(let i=0;i<5;i++) main.appendChild(document.createElement('td'));    // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØºØ§ÙŠØ© ØªØ³ÙˆÙŠÙ‚

  /* Ø®Ø§Ù†Ø© ÙƒÙ„ÙØ© + Ø­Ø°Ù */
  main.appendChild(document.createElement('td')); // Ø§Ù„ÙƒÙ„ÙØ©
  const del=document.createElement('td');
  del.innerHTML='<span style="cursor:pointer;color:var(--danger);font-weight:bold;font-size:1.2rem">âœ–</span>';
del.onclick = () => deleteRow(main, cost);   // ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­Ø°Ù Ù…Ù† Appwrite
  main.appendChild(del);

  /* ØµÙ Ø§Ù„ÙƒÙ„Ù */
  for(let i=0;i<3;i++) cost.appendChild(document.createElement('td'));
  for(let i=0;i<19;i++){
    const td=document.createElement('td');
    td.contentEditable=true;td.style.direction='rtl';td.classList.add('cost-input');
    td.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();updateRowTotal(cost);} });
    cost.appendChild(td);
  }
  const totalCell=document.createElement('td');totalCell.classList.add('total-cell');cost.appendChild(totalCell);
  cost.appendChild(document.createElement('td'));

  body.appendChild(main); body.appendChild(cost);
  if(!skipSave) saveRowToAppwrite(main,cost,dateTime,room);

  [...main.querySelectorAll('td[contenteditable]'),
   ...cost.querySelectorAll('td[contenteditable]')]
   .forEach(td=>td.addEventListener('blur',()=>syncRowUpdate(main,cost)));
}

/* ---------- Ø­Ø³Ø§Ø¨ ÙƒÙ„ÙØ© ØµÙ ---------- */
function updateRowTotal(costRow){
  let sum=0;
  costRow.querySelectorAll('td.cost-input').forEach(c=>{
    const v=parseFloat(c.textContent.replace(/,/g,'').trim());
    if(!isNaN(v)) sum+=v;
  });
  costRow.querySelector('.total-cell').textContent=sum?sum.toLocaleString():'';
  calculateSummary();
}

/* ---------- Ø­ÙØ¸ ØµÙ ---------- */
function saveRowToAppwrite(main,cost,dateTime,room){
  const m=main.querySelectorAll('td'); const c=cost.querySelectorAll('td.cost-input');
  const payload={
    priority   :m[0].textContent,
    lectureNumber:m[1].textContent,
    teacherName:m[2].textContent,
    recordDate :dateTime,
    recordRoom :room,
    mainCells  :[...m].slice(3,m.length-2).map(td=>td.textContent),
    cellColors :[...m].slice(3,m.length-2).map(td=>td.style.backgroundColor||''),
    costs      :[...c].map(td=>td.textContent),
    totalCost  :cost.querySelector('.total-cell').textContent
  };
  databases.createDocument(databaseId,collectionId,ID.unique(),payload)
    .then(doc=>{main.dataset.docId=cost.dataset.docId=doc.$id;})
    .catch(console.error);
}

/* ---------- ØªØ­Ø¯ÙŠØ« ØµÙ ---------- */
function syncRowUpdate(main,cost){
  const id=main.dataset.docId; if(!id) return;
  updateRowTotal(cost);

  const m=main.querySelectorAll('td'); const c=cost.querySelectorAll('td.cost-input');
  const data={
    priority   :m[0].textContent,
    lectureNumber:m[1].textContent,
    teacherName:m[2].textContent,
    recordDate :m[13].textContent,
    recordRoom :m[14].textContent,
    mainCells  :[...m].slice(3,m.length-2).map(td=>td.textContent),
    cellColors :[...m].slice(3,m.length-2).map(td=>td.style.backgroundColor||''),
    costs      :[...c].map(td=>td.textContent),
    totalCost  :cost.querySelector('.total-cell').textContent
  };
  databases.updateDocument(databaseId,collectionId,id,data).catch(console.error);
  sortTable(); // ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
}

/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========== */
function loadFromAppwrite(){
  databases.listDocuments(databaseId,collectionId).then(({documents})=>{
    documents.forEach(doc=>{
      addLectureRow(doc.priority,doc.lectureNumber,doc.teacherName,
                    doc.recordDate,doc.recordRoom,true);
      const rows=document.querySelectorAll('#tableBody tr');
      const cost=rows[rows.length-1];
      const main=rows[rows.length-2];
      main.dataset.docId=cost.dataset.docId=doc.$id;

      main.querySelectorAll('td').forEach((td,i)=>{
        if(i>=3 && i<main.children.length-2) td.textContent=doc.mainCells[i-3]||'';
      });
      doc.cellColors?.forEach((clr,i)=>{
        const td=main.children[3+i]; if(td) td.style.backgroundColor=clr;
      });
      cost.querySelectorAll('td.cost-input').forEach((td,i)=>{td.textContent=doc.costs[i]||'';});
      cost.querySelector('.total-cell').textContent=doc.totalCost||'';

      [...main.querySelectorAll('td[contenteditable]'),
       ...cost.querySelectorAll('td[contenteditable]')]
       .forEach(td=>td.addEventListener('blur',()=>syncRowUpdate(main,cost)));
    });
    calculateSummary(); sortTable();
    if(!window.realtimeStarted){initRealtime();window.realtimeStarted=true;}
  }).catch(console.error);
}

/* ========== Realtime ========== */
function initRealtime(){
  const channel=`databases.${databaseId}.collections.${collectionId}.documents`;
  client.subscribe(channel,(res)=>{
    const event=res.event||res.events?.[0]||"";
    const doc  =res.payload||{};

    if(event.endsWith(".create")){
      addLectureRow(doc.priority,doc.lectureNumber,doc.teacherName,
                    doc.recordDate,doc.recordRoom,true);
      sortTable();
    }
    else if(event.endsWith(".update")){
      const main=document.querySelector(`tr[data-doc-id="${doc.$id}"]`);
      if(!main) return;
      const cost=main.nextElementSibling;
      main.children[13].textContent=doc.recordDate;
      main.children[14].textContent=doc.recordRoom;
      doc.mainCells.forEach((v,i)=>{main.children[3+i].textContent=v;});
      doc.cellColors?.forEach((clr,i)=>{
        const td=main.children[3+i]; if(td) td.style.backgroundColor=clr;
      });
      cost.querySelectorAll('td.cost-input').forEach((td,i)=>{td.textContent=doc.costs[i]||'';});
      cost.querySelector('.total-cell').textContent=doc.totalCost||'';
      calculateSummary(); sortTable();
    }
    else if(event.endsWith(".delete")){
      const main=document.querySelector(`tr[data-doc-id="${doc.$id}"]`);
      if(main){
        const cost=main.nextElementSibling;
        main.remove(); if(cost) cost.remove();
        calculateSummary(); sortTable();
      }
    }
  });
}

/* ========== Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ ========== */
function calculateSummary(){
  let total=0;
  document.querySelectorAll('.total-cell').forEach(c=>{
    const v=parseFloat(c.textContent.replace(/,/g,''));
    if(!isNaN(v)) total+=v;
  });
  totalCost.textContent=total.toLocaleString();
}

/* ========== ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ ========== */
function sortTable(){
  const body=tableBodyEl; const pairs=[];
  for(let i=0;i<body.children.length;i+=2){
    const main=body.children[i],cost=body.children[i+1];
    const prio=main.children[0].textContent==='âœ…'?0:1;
const dateText = main.children[13]?.textContent?.trim() || '2100-01-01T00:00';
const date = new Date(dateText).getTime();
    pairs.push({main,cost,prio,date});
  }
  pairs.sort((a,b)=>a.prio-b.prio||a.date-b.date);
  pairs.forEach(p=>{body.appendChild(p.main);body.appendChild(p.cost);});
}

/* ========== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ========== */
document.addEventListener('contextmenu',e=>{
  if(!e.target.isContentEditable) return;

  const nameCols=[4,6,8,10,12,14,16,18,20];
  const cell=e.target; const col=[...cell.parentNode.children].indexOf(cell);

  const menu=document.createElement('div');
  menu.style=`position:fixed;top:${e.clientY}px;left:${e.clientX}px;background:#fff;
    border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);
    z-index:1000;padding:6px 0;min-width:160px`;
  document.querySelectorAll('body>.context-menu-color').forEach(m=>m.remove());
  menu.classList.add('context-menu-color');

  if(nameCols.includes(col)){
    ["ÙƒÙ†Ø§Ù† Ø§Ù„ÙØ±Ø§Ù†","Ø£Ø­Ù…Ø¯ Ø²Ø±Ù†ÙŠØ®","Ù…Ø§ÙŠØ§ ÙˆÙ‡Ø§Ø¨ÙŠØ©","Ø³Ù†Ø§ Ø²ÙŠØ§Ø¯Ø©","Ù…ØµØ·ÙÙ‰ Ø­Ù…Ø²Ø©","Ù…Ø­Ù…Ø¯ ÙØ§Ø±Ø³"]
      .forEach(name=>{
        const o=document.createElement('div');
        o.textContent=name;o.style.padding='10px 16px';o.style.cursor='pointer';
        o.onclick=()=>{cell.textContent=name;menu.remove();
          const main=cell.closest('tr[data-doc-id]');const cost=main?.nextElementSibling;
          if(main&&cost) syncRowUpdate(main,cost);
        };
        menu.appendChild(o);
      });
  }else{
    const colors=["transparent","#fff9c4","#ffe082","#c8e6c9","#212121"];
    const labels=["Ø´ÙØ§Ù","Ø£ØµÙØ± ÙØ§ØªØ­","Ø£ØµÙØ± ØºØ§Ù…Ù‚","Ø£Ø®Ø¶Ø±","Ø£Ø³ÙˆØ¯"];
    colors.forEach((color,i)=>{
      const o=document.createElement('div');
      o.textContent=labels[i];o.style.padding='10px 16px';o.style.cursor='pointer';
      o.style.backgroundColor=color==='transparent'?'#fff':color;
      o.style.color=color==='#212121'?'#fff':'#000';
      o.onclick=()=>{
        cell.style.backgroundColor=color;menu.remove();
        const main=cell.closest('tr[data-doc-id]');const cost=main?.nextElementSibling;
        if(main&&cost) syncRowUpdate(main,cost);
      };
      menu.appendChild(o);
    });
  }
  document.body.appendChild(menu);
  document.addEventListener('click',()=>{menu.remove();},{once:true});
  e.preventDefault();
});
</script>
</body>
</html>

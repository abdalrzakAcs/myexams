<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ø§Ù… My Exams</title>

  <!-- Ø®Ø· ÙƒØ§ÙŠØ±Ùˆ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />

  <!-- ====== Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© ====== -->
  <style>
    :root {
      --primary: #0069d9;
      --primary-hover: #0053b3;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #dfe3e8;
      --text-dark: #212529;
      --shadow: 0 6px 24px rgba(0, 0, 0, .08);
      --danger: #dc3545;
    }
    * {
      box-sizing: border-box;
      font-family: "Cairo", sans-serif;
      transition: .3s;
    }
    body {
      margin: 0;
      padding: 32px 16px;
      background: var(--light-bg);
      color: var(--text-dark);
    }
    h2 {
      margin: 0 0 32px;
      text-align: center;
      font: 700 2.2rem/1 "Cairo";
      color: var(--primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, .1);
    }
    .login-box {
      max-width: 420px;
      margin: 0 auto 40px;
      background: #fff;
      padding: 28px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .login-box input,
    .login-box button {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
    }
    .login-box button {
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 12px rgba(0, 105, 217, .3);
    }
    .login-box button:hover {
      background: var(--primary-hover);
      transform: scale(1.05);
    }
    #taskForm {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      max-width: 1150px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 36px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      align-items: end;
    }
    #taskForm label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      gap: 8px;
    }
    #taskForm input,
    #taskForm select,
    #taskForm button {
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
    }
    #taskForm button {
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    #taskForm button:hover {
      background: var(--primary-hover);
      transform: scale(1.04);
    }
    .table-wrapper {
      max-width: 100%;
      max-height: 70vh;
      overflow: auto;
      margin-top: 48px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      background: var(--card-bg);
    }
    table {
      width: 100%;
      min-width: 1350px;
      border-collapse: collapse;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #e9ecef;
      font-weight: bold;
      padding: 16px 0;
    }
    th, td {
      padding: 12px 10px;
      border: 1px solid var(--border);
      text-align: center;
      font-size: .9rem;
      white-space: nowrap;
    }
    tr:nth-child(even) {
      background: #fdfdfd;
    }
    tr:hover:not(.accounting-row) {
      background: #f1f5f8;
    }
    .accounting-row td {
      background: #fffde7;
      font-weight: bold;
    }
    .total-summary {
      margin-top: 20px;
      max-width: 1150px;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <p style="text-align:center;font-size:1.8rem;font-weight:bold;color:#0069d9;margin:0 0 20px;text-shadow:0 2px 4px rgba(0,0,0,.1)">
    Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù
  </p>
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù…Ø´Ø±ÙˆØ¹ My Exams</h2>
  <div class="login-box" id="loginBox">
    <input type="password" id="adminPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button type="button" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
  </div>
  <form id="taskForm">
    <label><input type="checkbox" id="priorityFlag" /> Ø£ÙˆÙ„ÙˆÙŠØ©</label>
    <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©
      <input type="text" id="sessionNumber" required />
    </label>
    <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°
      <input type="text" id="teacherName" required />
    </label>
    <label>ØªØ§Ø±ÙŠØ®/Ø³Ø§Ø¹Ø© Ø§Ù„ØªØµÙˆÙŠØ±
      <input type="datetime-local" id="recordDateTime" required />
    </label>
    <label>Ø§Ù„Ù‚Ø§Ø¹Ø©
      <select id="recordRoom" required>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
    </label>
    <button type="button" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
  </form>
  <div style="text-align:center;margin-top:8px">
    <button id="refreshBtn" style="padding:8px 18px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer;display:none">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div>
  <div class="table-wrapper">
    <table id="taskTable">
      <thead>
        <tr>
          <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th><th>ØªÙ†Ø³ÙŠÙ‚</th><th>Ù…Ù†Ø³Ù‚</th><th>Ø±ÙØ¹</th><th>Ø±Ø§ÙØ¹</th>
          <th>Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ù</th><th>Ù…Ø¯Ø®Ù„</th><th>Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø©</th><th>Ø±Ø§ÙØ¹</th><th>Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¦Ù„Ø©</th><th>Ù…Ø¯Ø®Ù„</th>
          <th>Ø§Ù„ØªØµÙˆÙŠØ±</th><th>Ø§Ù„Ù‚Ø§Ø¹Ø©</th><th>Ø§Ù„Ù…ØµÙˆØ±</th><th>Ù…ÙˆÙ†ØªØ§Ø¬</th><th>Ù…Ù…Ù†ØªØ¬</th><th>Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ</th><th>Ù…Ø¯Ø®Ù„</th>
          <th>ØªØµÙ…ÙŠÙ…/ÙƒØªØ§Ø¨Ø©</th><th>Ø§Ù„ÙƒØ§ØªØ¨</th><th>ØªØ³ÙˆÙŠÙ‚</th><th>Ø§Ù„ÙƒÙ„ÙØ©</th><th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  <div class="total-summary" id="summaryBox" style="display:none">
    <span>ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙØ©:</strong> <span id="totalCost">0</span> Ù„.Ø³</span>
    <span id="offlineBadge" class="hidden" style="color:var(--danger);font-weight:bold">ğŸš« Ø£ÙˆÙÙ„Ø§ÙŠÙ†</span>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Appwrite
    const { Client, Databases, Account, ID } = Appwrite;
    const client = new Client()
      .setEndpoint('https://fra.cloud.appwrite.io/v1')
      .setProject('66cf3db2002471686c6f');
    const account = new Account(client);
    const databases = new Databases(client);
    const databaseId = '68136c4cee33221deb0f';
    const collectionId = 'tasks';

    // Ø¹Ù†Ø§ØµØ± DOM
    const $ = id => document.getElementById(id);
    const adminPass = $('adminPass');
    const addBtn = $('addBtn');
    const refreshBtn = $('refreshBtn');
    const loginBox = $('loginBox');
    const taskForm = $('taskForm');
    const summaryBox = $('summaryBox');
    const tableBodyEl = $('tableBody');
    const totalCostEl = $('totalCost');
    const offlineBadge = $('offlineBadge');
    const priorityFlag = $('priorityFlag');
    const sessionNumber = $('sessionNumber');
    const teacherName = $('teacherName');
    const recordDateTime = $('recordDateTime');
    const recordRoom = $('recordRoom');

    // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±
    const PASSWORDS = {
      admin: 'Admin12',
      accountant: 'account123',
      coordinator: 'design123',
      entry: 'entry123',
      cameraman: 'photo123',
      montage: 'edit123',
      media: 'social123',
      marketing: 'market123'
    };
    let currentRole = 'guest';
    const roleCols = {
      admin: 'all',
      accountant: 'all',
      coordinator: [0,1,2,3,4,7,25],
      entry: [0,1,2,7,8,11,12,18,19],
      cameraman: [0,1,2,13,14],
      montage: [0,1,2,13,16,17],
      media: [0,1,2,7,11,18],
      marketing: [22]
    };
    const editableByRole = {
      coordinator: [3,4,7],
      entry: [7,8,11,12,18,19],
      montage: [16,17],
      media: [7,11,18],
      marketing: [22]
    };

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function checkLogin() {
      const pass = adminPass.value.trim();
      for (const [role, pwd] of Object.entries(PASSWORDS)) {
        if (pass === pwd) { currentRole = role; break; }
      }
      if (currentRole === 'guest') return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      loginBox.style.display = 'none';
      taskForm.style.display = currentRole === 'admin' ? 'grid' : 'none';
      addBtn.style.display = currentRole === 'admin' ? 'inline-block' : 'none';
      summaryBox.style.display = 'flex';
      refreshBtn.style.display = 'inline-block';
      account.get().then(loadFromAppwrite).catch(() => account.createAnonymousSession().then(loadFromAppwrite).catch(console.error));
      setInterval(() => databases.listDocuments(databaseId, collectionId, [], 1, 0).catch(() => {}), 10000);
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
    addBtn.addEventListener('click', async () => {
      const priority = priorityFlag.checked ? 'âœ…' : 'âŒ';
      const lecture = sessionNumber.value.trim();
      const teacher = teacherName.value.trim();
      const dateTime = recordDateTime.value;
      if (!lecture || !teacher || !dateTime) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      const payload = {
        priority,
        lectureNumber: lecture,
        teacherName: teacher,
        recordDate: new Date(dateTime).toISOString(),
        recordRoom: recordRoom.value,
        mainCells: Array(10).fill(''),
        cellColors: Array(10).fill(''),
        costs: Array(10).fill(''),
        totalCost: ''
      };
      try {
        const doc = await databases.createDocument(databaseId, collectionId, ID.unique(), payload);
        addLectureRow(priority, lecture, teacher, dateTime, recordRoom.value, true, doc.$id);
        taskForm.reset(); sortTable();
      } catch (e) {
        console.error(e); alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸!');
      }
    });

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    function addLectureRow(priority, num, teacher, dateTime, room, skipSave = false, docId = null) {
      const main = document.createElement('tr');
      const cost = document.createElement('tr'); cost.classList.add('accounting-row');
      if (docId) { main.dataset.docId = cost.dataset.docId = docId; }
      [priority, num, teacher].forEach(v => { const td = document.createElement('td'); td.textContent = v; main.appendChild(td); });
      for (let i = 0; i < 10; i++) { const td = document.createElement('td'); td.contentEditable = true; td.style.direction = 'rtl'; main.appendChild(td); }
      const formatted = new Intl.DateTimeFormat('ar-SY', { dateStyle: 'short', timeStyle: 'short', hour12: false }).format(new Date(dateTime));
      [formatted, room].forEach(val => { const td = document.createElement('td'); td.textContent = val; main.appendChild(td); });
      for (let i = 0; i < 7; i++) main.appendChild(document.createElement('td'));
      main.appendChild(document.createElement('td'));
      const del = document.createElement('td'); del.innerHTML = 'âœ–'; del.style = 'cursor:pointer;color:var(--danger);font-weight:bold'; del.onclick = () => deleteRow(main, cost); main.appendChild(del);
      for (let i = 0; i < 3; i++) cost.appendChild(document.createElement('td'));
      for (let i = 0; i < 10; i++) { const td = document.createElement('td'); td.contentEditable = true; td.classList.add('cost-input'); cost.appendChild(td); }
      for (let i = 0; i < 10; i++) cost.appendChild(document.createElement('td'));
      const totalCell = document.createElement('td'); totalCell.classList.add('total-cell'); cost.appendChild(totalCell);
      cost.appendChild(document.createElement('td'));
      tableBodyEl.append(main, cost);
      [...main.querySelectorAll('[contenteditable]'), ...cost.querySelectorAll('[contenteditable]')].forEach(td => td.addEventListener('blur', () => syncRowUpdate(main, cost)));
      if (!skipSave) saveRowToAppwrite(main, cost, dateTime, room);
      applyPermissionsToRow(main, cost);
    }
 function deleteRow(main,cost){
  if(currentRole!=='admin') return;
  const id=main.dataset.docId;
  main.remove(); cost.remove(); calculateSummary();
  if(id) databases.deleteDocument(databaseId,collectionId,id).catch(console.error);
}
  function syncRowUpdate(main,cost){
  if(!navigator.onLine){
    pushToQueue('update',{id:main.dataset.docId,data:collectRowData(main,cost)}); return;
  }
  updateRowTotal(cost);
  if(currentRole==='accountant') return;
  databases.updateDocument(databaseId,collectionId,main.dataset.docId,collectRowData(main,cost))
           .catch(console.error);
  sortTable();
}
function collectRowData(main,cost){
  const m=main.querySelectorAll('td');
  const c=cost.querySelectorAll('.cost-input');
  return {
    priority     : m[0].textContent,
    lectureNumber: m[1].textContent,
    teacherName  : m[2].textContent,
    recordDate   : m[13].textContent,
    recordRoom   : m[14].textContent,
    mainCells    : [...m].slice(3,13).map(td=>td.textContent),
    cellColors   : [...m].slice(3,13).map(td=>td.style.backgroundColor||''),
    costs        : [...c].map(td=>td.textContent),
    totalCost    : cost.querySelector('.total-cell').textContent
  };
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function loadFromAppwrite(){
  databases.listDocuments(databaseId,collectionId)
    .then(({documents})=>{
      tableBodyEl.innerHTML='';
      documents.forEach(doc=>addLectureRow(
        doc.priority,doc.lectureNumber,doc.teacherName,
        doc.recordDate,doc.recordRoom,true,doc.$id));
      calculateSummary(); sortTable(); applyPermissions(); initRealtimeOnce();
    }).catch(console.error);
}

/* Ø±ÙŠÙ„ ØªØ§ÙŠÙ… */
let realtimeStarted=false;
function initRealtimeOnce(){ if(!realtimeStarted){ initRealtime(); realtimeStarted=true; } }
function initRealtime(){
  const ch=databases.${databaseId}.collections.${collectionId}.documents;
  client.subscribe(ch,res=>{
    const ev=res.event||res.events?.[0]||''; const doc=res.payload||{};
    if(ev.endsWith('.create')){
      if(document.querySelector(tr[data-doc-id="${doc.$id}"])) return;
      addLectureRow(doc.priority,doc.lectureNumber,doc.teacherName,
                    doc.recordDate,doc.recordRoom,true,doc.$id);
      sortTable();
    }else if(ev.endsWith('.update')){
      const main=document.querySelector(tr[data-doc-id="${doc.$id}"]);
      if(!main) return;
      const cost=main.nextElementSibling;
      main.children[13].textContent = Intl.DateTimeFormat('ar-SY',
        {dateStyle:'short',timeStyle:'short',hour12:false})
        .format(new Date(doc.recordDate));
      main.children[14].textContent = doc.recordRoom;
      doc.mainCells .forEach((v,i)=>main.children[3+i].textContent=v);
      doc.cellColors.forEach((c,i)=>main.children[3+i].style.backgroundColor=c||'');
      cost.querySelectorAll('.cost-input').forEach((td,i)=>td.textContent=doc.costs[i]||'');
      cost.querySelector('.total-cell').textContent = doc.totalCost||'';
      calculateSummary(); sortTable();
    }else if(ev.endsWith('.delete')){
      const main=document.querySelector(tr[data-doc-id="${doc.$id}"]);
      if(main){ const cost=main.nextElementSibling; main.remove(); cost.remove(); calculateSummary(); }
    }
  });
}

/* Ø§Ù„ÙƒÙ„ÙØ© */
function updateRowTotal(costRow){
  let sum=0;
  costRow.querySelectorAll('.cost-input').forEach(c=>{
    const v=parseFloat(c.textContent.replace(/,/g,''));
    if(!isNaN(v)) sum+=v;
  });
  costRow.querySelector('.total-cell').textContent = sum?sum.toLocaleString():'';
  calculateSummary();
}
function calculateSummary(){
  let total=0;
  document.querySelectorAll('.total-cell').forEach(c=>{
    const v=parseFloat(c.textContent.replace(/,/g,''));
    if(!isNaN(v)) total+=v;
  });
  totalCostEl.textContent = total.toLocaleString();
}

/* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
function sortTable(){
  const pairs=[];
  for(let i=0;i<tableBodyEl.children.length;i+=2){
    const main=tableBodyEl.children[i], cost=tableBodyEl.children[i+1];
    const prio=main.children[0].textContent==='âœ…'?0:1;
    const t=main.children[13]?.textContent.trim()||'2100-01-01 00:00';
    pairs.push({main,cost,prio,time:new Date(t.replace(/[\u200f\u200e]/g,'')).getTime()});
  }
  pairs.sort((a,b)=>a.prio-b.prio||a.time-b.time)
       .forEach(p=>tableBodyEl.append(p.main,p.cost));
}

/* Ø¯Ø¹Ù… Offline */
const localQueueKey='myExamsQueue_v1';
function pushToQueue(action,payload){
  const q=JSON.parse(localStorage.getItem(localQueueKey)||'[]'); q.push({action,payload});
  localStorage.setItem(localQueueKey,JSON.stringify(q));
}
async function flushQueue(){
  if(!navigator.onLine) return;
  const q=JSON.parse(localStorage.getItem(localQueueKey)||'[]'); if(!q.length) return;
  for(const item of q){
    try{
      if(item.action==='update'){
        await databases.updateDocument(databaseId,collectionId,item.payload.id,item.payload.data);
      }
    }catch(e){console.error('Sync error',e); return;}
  }
  localStorage.removeItem(localQueueKey);
}
window.addEventListener('online', ()=>{offlineBadge.classList.add('hidden');flushQueue();});
window.addEventListener('offline',()=>offlineBadge.classList.remove('hidden'));
if(!navigator.onLine) offlineBadge.classList.remove('hidden');

/* Ø­ÙØ¸ ØµÙ Ø¬Ø¯ÙŠØ¯ */
function saveRowToAppwrite(main,cost,dateTime,room){
  const m=main.querySelectorAll('td'), c=cost.querySelectorAll('.cost-input');
  const data={
    priority:m[0].textContent, lectureNumber:m[1].textContent, teacherName:m[2].textContent,
    recordDate:new Date(dateTime).toISOString(), recordRoom:room,
    mainCells:[...m].slice(3,13).map(td=>td.textContent),
    cellColors:[...m].slice(3,13).map(td=>td.style.backgroundColor||''),
    costs:[...c].map(td=>td.textContent),
    totalCost:cost.querySelector('.total-cell').textContent
  };
  databases.createDocument(databaseId,collectionId,ID.unique(),data)
           .then(doc=>{main.dataset.docId=cost.dataset.docId=doc.$id;})
           .catch(console.error);
}

/* Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */
function applyPermissions(){
  [...tableBodyEl.querySelectorAll('tr'), $('taskTable').querySelector('thead tr')]
    .forEach(tr=>applyPermissionsToRow(tr,tr.nextElementSibling?.classList.contains('accounting-row')?tr.nextElementSibling:null));
}
function applyPermissionsToRow(main,cost){
  if(!main) return;
  const role=currentRole; const cols=roleCols[role]; const editable=editableByRole[role]||[];
  const cells=[...main.children];
  cells.forEach((td,i)=>{
    const show=(cols==='all'||cols.includes(i));
    td.classList.toggle('hidden',!show);
    td.contentEditable = (role==='admin') ? (i!==cells.length-1) : editable.includes(i);
  });
  if(cost){
    [...cost.children].forEach((td,i)=>{
      const show=(cols==='all'||cols.includes(i));
      td.classList.toggle('hidden',!show);
      td.contentEditable = role==='admin' ? true : editable.includes(i+26);
    });
  }
  cells[cells.length-1].classList.toggle('hidden',role!=='admin'); // Ø²Ø± Ø§Ù„Ø­Ø°Ù
}
  </script>
</body>
</html>

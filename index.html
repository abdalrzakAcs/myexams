<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ø§Ù… My Exams</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --primary:#0069d9;--primary-hover:#0053b3;--light-bg:#f5f7fa;
      --card-bg:#ffffff;--border:#dfe3e8;--text-dark:#212529;
      --shadow:0 6px 24px rgba(0,0,0,.08);--danger:#dc3545;
    }
    *{box-sizing:border-box;font-family:"Cairo",sans-serif;transition:.3s}
    body{margin:0;padding:32px 16px;background:var(--light-bg);color:var(--text-dark)}
    h2{text-align:center;margin-bottom:32px;font:700 2.2rem/1 "Cairo";color:var(--primary);text-shadow:0 2px 4px rgba(0,0,0,.1)}
    .login-box{max-width:420px;margin:0 auto 40px;background:#fff;padding:28px;border-radius:20px;box-shadow:var(--shadow);text-align:center}
    .login-box input,.login-box button{width:100%;padding:14px;margin:12px 0;border:1px solid var(--border);border-radius:10px;font-size:1rem}
    .login-box button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 3px 12px rgba(0,105,217,.3)}
    .login-box button:hover{background:var(--primary-hover);transform:scale(1.05)}
    #taskForm{display:none;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;max-width:1150px;margin:0 auto;background:var(--card-bg);padding:36px;border-radius:20px;box-shadow:var(--shadow);align-items:end}
    #taskForm label{display:flex;flex-direction:column;font-weight:600;gap:8px}
    #taskForm input,#taskForm select,#taskForm button{padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:1rem}
    #taskForm button{background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    #taskForm button:hover{background:var(--primary-hover);transform:scale(1.04)}
    .table-wrapper{max-width:100%;max-height:70vh;overflow:auto;margin-top:48px;border-radius:20px;box-shadow:var(--shadow);background:var(--card-bg)}
    table{width:100%;min-width:1350px;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#e9ecef;font-weight:bold;padding:16px 0}
    th,td{padding:12px 10px;border:1px solid var(--border);text-align:center;font-size:.9rem;white-space:nowrap}
    tr:nth-child(even){background:#fdfdfd}
    tr:hover:not(.accounting-row){background:#f1f5f8}
    .accounting-row td{background:#fffde7;font-weight:bold}
    .total-summary{margin-top:20px;max-width:1150px;background:#fff;padding:20px;border-radius:16px;box-shadow:var(--shadow);font-size:1.1rem;display:flex;justify-content:space-between;align-items:center}
    .context-menu-color{animation:fadeIn .12s ease-out;border-radius:8px}
    @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    .hidden{display:none!important}
  </style>
</head>
<body>
<div style="text-align:center;margin-bottom:20px">
  <p style="font-size:1.8rem;font-weight:bold;color:#0069d9;margin:0;text-shadow:0 2px 4px rgba(0,0,0,.1)">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p>
</div>

<h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ù…Ø´Ø±ÙˆØ¹ My Exams</h2>
<!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="login-box" id="loginBox">
  <input type="password" id="adminPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <button type="button" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ -->
<form id="taskForm">
  <label><input type="checkbox" id="priorityFlag" /> Ø£ÙˆÙ„ÙˆÙŠØ©</label>
  <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©<input type="text" id="sessionNumber" required/></label>
  <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°<input type="text" id="teacherName" required/></label>
  <label>ØªØ§Ø±ÙŠØ®/Ø³Ø§Ø¹Ø© Ø§Ù„ØªØµÙˆÙŠØ±
    <input type="datetime-local" id="recordDateTime" required/>
  </label>
  <label>Ø§Ù„Ù‚Ø§Ø¹Ø©
    <select id="recordRoom" required>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </label>
  <button type="button" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
</form>

<!-- Ø²Ø± ØªØ­Ø¯ÙŠØ« -->
<div style="text-align:center;margin-top:8px">
  <button id="refreshBtn" style="padding:8px 18px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:600;cursor:pointer;display:none">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
<div class="table-wrapper">
  <table id="taskTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ø£Ø³ØªØ§Ø°</th>
        <th>ØªÙ†Ø³ÙŠÙ‚</th><th>Ù…Ù†Ø³Ù‚</th><th>Ø±ÙØ¹</th><th>Ø±Ø§ÙØ¹</th>
        <th>Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ù</th><th>Ù…Ø¯Ø®Ù„</th><th>Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø©</th><th>Ø±Ø§ÙØ¹</th>
        <th>Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ø¦Ù„Ø©</th><th>Ù…Ø¯Ø®Ù„</th><th>Ø§Ù„ØªØµÙˆÙŠØ±</th><th>Ø§Ù„Ù‚Ø§Ø¹Ø©</th><th>Ø§Ù„Ù…ØµÙˆØ±</th>
        <th>Ù…ÙˆÙ†ØªØ§Ø¬</th><th>Ù…Ù…Ù†ØªØ¬</th><th>Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ</th><th>Ù…Ø¯Ø®Ù„</th>
        <th>ØªØµÙ…ÙŠÙ…/ÙƒØªØ§Ø¨Ø©</th><th>Ø§Ù„ÙƒØ§ØªØ¨</th><th>ØªØ³ÙˆÙŠÙ‚</th>
        <th>Ø§Ù„ÙƒÙ„ÙØ©</th><th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
<div class="total-summary" id="summaryBox" style="display:none">
  <span>ğŸ’° <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙØ©:</strong> <span id="totalCost">0</span> Ù„.Ø³</span>
  <span id="offlineBadge" class="hidden" style="color:var(--danger);font-weight:bold">ğŸš« Ø£ÙˆÙÙ„Ø§ÙŠÙ†</span>
</div>
<!-- Appwrite CDN -->
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Appwrite ========== */
const { Client, Databases, Account, ID } = Appwrite;
const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('66cf3db2002471686c6f');
const account   = new Account(client);
const databases = new Databases(client);
const databaseId = '68136c4cee33221deb0f';
const collectionId = 'tasks';

/* ========== Ø¹Ù†Ø§ØµØ± DOM ========== */
const adminPass = document.getElementById('adminPass');
const addBtn = document.getElementById('addBtn');
const refreshBtn = document.getElementById('refreshBtn');
const loginBox = document.getElementById('loginBox');
const taskForm = document.getElementById('taskForm');
const summaryBox = document.getElementById('summaryBox');
const tableBodyEl = document.getElementById('tableBody');
const totalCost = document.getElementById('totalCost');
const offlineBadge = document.getElementById('offlineBadge');

const priorityFlag = document.getElementById('priorityFlag');
const sessionNumber = document.getElementById('sessionNumber');
const teacherName = document.getElementById('teacherName');
const recordDateTime = document.getElementById('recordDateTime');
const recordRoom = document.getElementById('recordRoom');

/* ========== ØµÙ„Ø§Ø­ÙŠØ§Øª ========== */
const PASSWORDS = {
  admin:'Admin12', accountant:'account123',
  coordinator:'design123', entry:'entry123', cameraman:'photo123', montage:'edit123',
  media:'social123', marketing:'market123'
};
let currentRole='guest';

/* Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„ÙƒÙ„ Ø¯ÙˆØ± */
const roleCols = {
  admin:'all',
  accountant:'all',
  coordinator:[0,1,2,3,4,7,25],
  entry:[0,1,2,7,8,11,12,18,19],
  cameraman:[0,1,2,13,14],
  montage:[0,1,2,13,16,17],
  media:[0,1,2,7,11,18],
  marketing:[22]
};
/* Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ÙƒÙ„ Ø¯ÙˆØ± (ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†) */
const editableByRole = {
  coordinator:[3,4,7],
  entry:[7,8,11,12,18,19],
  cameraman:[],
  montage:[16,17],
  media:[7,11,18],
  marketing:[22]
};

/* ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ========== */
function checkLogin(){
  const pass = adminPass.value.trim();
  for(const [role,pwd] of Object.entries(PASSWORDS)){
    if(pass===pwd){currentRole=role;break;}
  }
  if(currentRole==='guest') return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

  loginBox.style.display='none';
  taskForm.style.display = currentRole==='admin'? 'grid':'none';
  addBtn.style.display = currentRole==='admin'?'inline-block':'none';
  summaryBox.style.display='flex';
  refreshBtn.style.display='inline-block';

  account.get().then(()=>loadFromAppwrite()).catch(()=>{
    account.createAnonymousSession().then(loadFromAppwrite).catch(console.error);
  });

  setInterval(()=>{
    databases.listDocuments(databaseId,collectionId,[],1,0).catch(()=>{});
  },10000);
}
/* ========== Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ ========== */
addBtn.addEventListener('click', async () => {
  const priority = priorityFlag.checked ? 'âœ…' : 'âŒ';
  const lectureNum = sessionNumber.value.trim();
  const teacher = teacherName.value.trim();
  const dateTime = recordDateTime.value;
  if (!lectureNum || !teacher || !dateTime) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
  const room = recordRoom.value;
  const emptyCells = Array(10).fill('');
  const payload = {
    priority,
    lectureNumber: lectureNum,
    teacherName: teacher,
    recordDate: new Date(dateTime).toISOString(),
    recordRoom: room,
    mainCells: emptyCells,
    cellColors: emptyCells,
    costs: emptyCells,
    totalCost: ''
  };
  try {
    const doc = await databases.createDocument(databaseId, collectionId, ID.unique(), payload);
    addLectureRow(priority, lectureNum, teacher, dateTime, room, true, doc.$id);
    taskForm.reset(); sortTable();
  } catch (e) {
    console.error(e);
    alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸!');
  }
});

/* ========== Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙ‘ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙƒÙ„ÙØ© ========== */
function addLectureRow(priority, num, teacher, dateTime, room, skipSave = false, docId = null) {
  const main = document.createElement('tr');
  const cost = document.createElement('tr');
  cost.classList.add('accounting-row');
  if (docId) {
    main.dataset.docId = cost.dataset.docId = docId;
  }

  [priority, num, teacher].forEach(v => {
    const td = document.createElement('td');
    td.textContent = v;
    main.appendChild(td);
  });

  // 10 Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªÙ†Ø³ÙŠÙ‚ØŒ Ø±Ø§ÙØ¹ØŒ Ù…Ø¯Ø®Ù„ØŒ ...Ø¥Ù„Ø®)
  for (let i = 0; i < 10; i++) {
    const td = document.createElement('td');
    td.contentEditable = true;
    td.style.direction = 'rtl';
    main.appendChild(td);
  }

  const formatted = Intl.DateTimeFormat('ar-SY', {
    dateStyle: 'short',
    timeStyle: 'short',
    hour12: false
  }).format(new Date(dateTime));
  const dtd = document.createElement('td');
  dtd.textContent = formatted;
  main.appendChild(dtd);

  const rtd = document.createElement('td');
  rtd.textContent = room;
  main.appendChild(rtd);

  // Ø§Ù„Ù…ØµÙˆØ± + Ù…ÙˆÙ†ØªØ§Ø¬ + Ø¥Ø¯Ø®Ø§Ù„Ø§Øª + Ø­Ø°Ù
  for (let i = 0; i < 7; i++) main.appendChild(document.createElement('td'));
  main.appendChild(document.createElement('td')); // Ø¹Ù…ÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙƒÙ„ÙØ© Ø£Ùˆ Ø­Ø°Ù Ù„Ø§Ø­Ù‚Ø§Ù‹
  const del = document.createElement('td');
  del.innerHTML = 'âœ–';
  del.style = "cursor:pointer;color:var(--danger);font-weight:bold;font-size:1.2rem";
  del.onclick = () => deleteRow(main, cost);
  main.appendChild(del);

  // ØµÙ Ø§Ù„ÙƒÙ„ÙØ©
  for (let i = 0; i < 3; i++) cost.appendChild(document.createElement('td'));
  for (let i = 0; i < 10; i++) {
    const td = document.createElement('td');
    td.contentEditable = true;
    td.classList.add('cost-input');
    cost.appendChild(td);
  }
  for (let i = 0; i < 10; i++) cost.appendChild(document.createElement('td'));
  const totalCell = document.createElement('td');
  totalCell.classList.add('total-cell');
  cost.appendChild(totalCell);
  cost.appendChild(document.createElement('td')); // Ù„Ù„Ø­Ø°Ù

  tableBodyEl.appendChild(main);
  tableBodyEl.appendChild(cost);

  [...main.querySelectorAll('td[contenteditable]'),
   ...cost.querySelectorAll('td[contenteditable]')]
    .forEach(td => td.addEventListener('blur', () => syncRowUpdate(main, cost)));

  if (!skipSave) saveRowToAppwrite(main, cost, dateTime, room);
  applyPermissionsToRow(main, cost);
}

/* Ø­Ø°Ù ØµÙ */
function deleteRow(main, cost) {
  if (currentRole !== 'admin') return;
  const id = main.dataset.docId;
  tableBodyEl.removeChild(main);
  tableBodyEl.removeChild(cost);
  calculateSummary();
  if (id) databases.deleteDocument(databaseId, collectionId, id).catch(console.error);
}
/* ========== ØªØ­Ø¯ÙŠØ« ØµÙ ========== */
function syncRowUpdate(main, cost) {
  if (!navigator.onLine) {
    pushToQueue('update', {
      id: main.dataset.docId,
      data: collectRowData(main, cost)
    });
    return;
  }

  updateRowTotal(cost);
  if (currentRole === 'accountant') return; // Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ù…Ø§ Ø¨ÙŠØ¹Ø¯Ù„ Ø´ÙŠ

  databases.updateDocument(databaseId, collectionId, main.dataset.docId, collectRowData(main, cost)).catch(console.error);
  sortTable();
}

/* ========== ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ========== */
function collectRowData(main, cost) {
  const m = main.querySelectorAll('td');
  const c = cost.querySelectorAll('td.cost-input');
  return {
    priority: m[0].textContent,
    lectureNumber: m[1].textContent,
    teacherName: m[2].textContent,
    recordDate: m[13].textContent,
    recordRoom: m[14].textContent,
    mainCells: [...m].slice(3, 13).map(td => td.textContent),
    cellColors: [...m].slice(3, 13).map(td => td.style.backgroundColor || ''),
    costs: [...c].map(td => td.textContent),
    totalCost: cost.querySelector('.total-cell').textContent
  };
}

/* ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Appwrite ========== */
function loadFromAppwrite() {
  databases.listDocuments(databaseId, collectionId).then(({ documents }) => {
    tableBodyEl.innerHTML = '';
    documents.forEach(doc =>
      addLectureRow(doc.priority, doc.lectureNumber, doc.teacherName, doc.recordDate, doc.recordRoom, true, doc.$id)
    );
    calculateSummary();
    sortTable();
    applyPermissions();
    initRealtimeOnce();
  }).catch(console.error);
}

/* ========== ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± (Realtime) ========== */
let realtimeStarted = false;
function initRealtimeOnce() {
  if (realtimeStarted) return;
  initRealtime();
  realtimeStarted = true;
}

function initRealtime() {
  const channel = `databases.${databaseId}.collections.${collectionId}.documents`;
  client.subscribe(channel, res => {
    const event = res.event || res.events?.[0] || '';
    const doc = res.payload || {};

    if (event.endsWith('.create')) {
      if (document.querySelector(`tr[data-doc-id="${doc.$id}"]`)) return;
      addLectureRow(doc.priority, doc.lectureNumber, doc.teacherName, doc.recordDate, doc.recordRoom, true, doc.$id);
      sortTable();
    } else if (event.endsWith('.update')) {
      const main = document.querySelector(`tr[data-doc-id="${doc.$id}"]`);
      if (!main) return;
      const cost = main.nextElementSibling;
      main.children[13].textContent = Intl.DateTimeFormat('ar-SY', { dateStyle: 'short', timeStyle: 'short', hour12: false }).format(new Date(doc.recordDate));
      main.children[14].textContent = doc.recordRoom;
      doc.mainCells.forEach((v, i) => main.children[3 + i].textContent = v);
      doc.cellColors.forEach((clr, i) => main.children[3 + i].style.backgroundColor = clr || '');
      cost.querySelectorAll('td.cost-input').forEach((td, i) => td.textContent = doc.costs[i] || '');
      cost.querySelector('.total-cell').textContent = doc.totalCost || '';
      calculateSummary();
      sortTable();
    } else if (event.endsWith('.delete')) {
      const main = document.querySelector(`tr[data-doc-id="${doc.$id}"]`);
      if (main) {
        const cost = main.nextElementSibling;
        main.remove();
        cost.remove();
        calculateSummary();
      }
    }
  });
}

/* ========== Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙØ© ========== */
function updateRowTotal(costRow) {
  let sum = 0;
  costRow.querySelectorAll('td.cost-input').forEach(c => {
    const v = parseFloat(c.textContent.replace(/,/g, ''));
    if (!isNaN(v)) sum += v;
  });
  costRow.querySelector('.total-cell').textContent = sum ? sum.toLocaleString() : '';
  calculateSummary();
}

function calculateSummary() {
  let total = 0;
  document.querySelectorAll('.total-cell').forEach(c => {
    const v = parseFloat(c.textContent.replace(/,/g, ''));
    if (!isNaN(v)) total += v;
  });
  totalCost.textContent = total.toLocaleString();
}

/* ========== ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ========== */
function sortTable() {
  const body = tableBodyEl;
  const pairs = [];
  for (let i = 0; i < body.children.length; i += 2) {
    const main = body.children[i];
    const cost = body.children[i + 1];
    const prio = main.children[0].textContent === 'âœ…' ? 0 : 1;
    const dateText = main.children[13]?.textContent.trim() || '2100-01-01 00:00';
    const date = new Date(dateText.replace(/[\u200f\u200e]/g, '')).getTime();
    pairs.push({ main, cost, prio, date });
  }
  pairs.sort((a, b) => a.prio - b.prio || a.date - b.date);
  pairs.forEach(p => {
    body.appendChild(p.main);
    body.appendChild(p.cost);
  });
}
/* ---------- Ø¯Ø¹Ù… Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† ---------- */
const localQueueKey = 'myExamsQueue_v1';

function pushToQueue(action, payload){
  const q = JSON.parse(localStorage.getItem(localQueueKey) || '[]');
  q.push({ action, payload });
  localStorage.setItem(localQueueKey, JSON.stringify(q));
}

async function flushQueue(){
  if (!navigator.onLine) return;
  const q = JSON.parse(localStorage.getItem(localQueueKey) || '[]');
  if (!q.length) return;

  for (const item of q){
    try{
      if(item.action === 'update'){
        await databases.updateDocument(databaseId, collectionId, item.payload.id, item.payload.data);
      }
      // Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ø¯Ø¹Ù… create Ø£Ùˆ delete Ø£Ø¶Ù Ø­Ø§Ù„Ø§Øª Ù‡Ù†Ø§
    }catch(e){ console.error('Sync error', e); return; }
  }
  localStorage.removeItem(localQueueKey);
}

window.addEventListener('online', ()=>{ offlineBadge.classList.add('hidden'); flushQueue(); });
window.addEventListener('offline', ()=> offlineBadge.classList.remove('hidden'));
if(!navigator.onLine) offlineBadge.classList.remove('hidden');

/* ========== ØªØ·Ø¨ÙŠÙ‚ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ„ Ø­Ø³Ø§Ø¨ ========== */
function applyPermissions() {
  const allTrs = [...tableBodyEl.querySelectorAll('tr'), document.querySelector('#taskTable thead tr')];
  allTrs.forEach(tr => applyPermissionsToRow(tr, tr.nextElementSibling?.classList.contains('accounting-row') ? tr.nextElementSibling : null));
}
function saveRowToAppwrite(main, cost, dateTime, room){
  const m = main.querySelectorAll('td');
  const c = cost.querySelectorAll('td.cost-input');
  const data = {
    priority: m[0].textContent,
    lectureNumber: m[1].textContent,
    teacherName: m[2].textContent,
    recordDate: new Date(dateTime).toISOString(),
    recordRoom: room,
    mainCells: [...m].slice(3,13).map(td=>td.textContent),
    cellColors: [...m].slice(3,13).map(td=>td.style.backgroundColor || ''),
    costs: [...c].map(td=>td.textContent),
    totalCost: cost.querySelector('.total-cell').textContent
  };
  databases.createDocument(databaseId, collectionId, ID.unique(), data)
    .then(doc => { main.dataset.docId = cost.dataset.docId = doc.$id; })
    .catch(console.error);
}

function applyPermissionsToRow(main, cost) {
  if (!main) return;

  const role = currentRole;
  const cols = roleCols[role];
  const editable = editableByRole[role] || [];
  const cells = [...main.children];

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‡Ø§
  if (cols !== 'all') {
    cells.forEach((td, i) => {
      if (!cols.includes(i)) td.classList.add('hidden');
      else td.classList.remove('hidden');
      td.contentEditable = editable.includes(i) || role === 'admin';
    });
  } else {
    cells.forEach((td, i) => {
      td.classList.remove('hidden');
      td.contentEditable = role !== 'accountant';
    });
  }

  // ÙƒÙ„ÙØ© (Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ)
  if (cost) {
    [...cost.children].forEach((td, i) => {
      if (cols !== 'all' && !cols.includes(i)) td.classList.add('hidden');
      else td.classList.remove('hidden');
      td.contentEditable = editable.includes(i + 26) || role === 'admin'; // 26 Ù„Ø£Ù†Ù‡ Ø§Ù„ÙƒÙ„ÙØ© Ø¨Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ù†ÙŠ
    });
  }

  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¥Ø°Ø§ Ù…Ùˆ Ø£Ø¯Ù…ÙŠÙ†
  const delIdx = 25;
  const delCell = cells[delIdx];
  if (role !== 'admin') delCell.classList.add('hidden');
  else delCell.classList.remove('hidden');
}
</body>
</html>
